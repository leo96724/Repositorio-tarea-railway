version: 2.1

jobs:
  deploy_app_to_railway:
    docker:
      - image: cimg/node:20.9
    working_directory: ~/project
    steps:
      - checkout

      - run:
          name: Instalar Railway CLI (local)
          command: |
            npm install @railway/cli
            npx railway --version

      - run:
          name: Link al proyecto Railway
          command: |
            # RAILWAY_TOKEN se toma del entorno (Project Settings > Environment Variables)
            npx railway link -p "$RAILWAY_PROJECT_ID"
            # Opcional para diagnóstico:
            npx railway status || true
            # npx railway whoami || true

      - run:
          name: Deploy al servicio
          command: |
            # Si tu Dockerfile está en la RAÍZ del repo, deja esto tal cual:
            npx railway up --service "$RAILWAY_SERVICE" --detach

            # Si construyes desde bankchurn-api/, usa esto en su lugar:
            # cd bankchurn-api
            # npx railway up --service "$RAILWAY_SERVICE" --detach

workflows:
  deploy_pipeline:
    jobs:
      - deploy_app_to_railway:
          filters:
            branches:
              only:
                - main
