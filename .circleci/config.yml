version: '2.1'
orbs:
  node: circleci/node@5.1.0

jobs:
  deploy_app_to_railway:
    docker:
      - image: cimg/node:20.9
    steps:
      - checkout
      - node/install:
          node-version: '20.9'
      - run: node --version
      - run:
          name: Railway CLI (npx)
          command: npx -y @railway/cli --version

      # DEBUG opcional: comprobar que llega el token
      - run:
          name: Debug env
          command: |
            echo "len(RAILWAY_TOKEN)=${#RAILWAY_TOKEN}"
            echo "PROJECT_ID=$RAILWAY_PROJECT_ID"
            echo "SERVICE=$RAILWAY_SERVICE"

      - run:
          name: Link al proyecto Railway
          command: |
            RAILWAY_TOKEN="$RAILWAY_TOKEN" npx -y @railway/cli link -p "$RAILWAY_PROJECT_ID"
            RAILWAY_TOKEN="$RAILWAY_TOKEN" npx -y @railway/cli status || true

      - run:
          name: Deploy to Railway (Dockerfile en ra√≠z)
          command: |
            RAILWAY_TOKEN="$RAILWAY_TOKEN" npx -y @railway/cli up \
              --service "$RAILWAY_SERVICE" \
              --detach --verbose

workflows:
  deploy_pipeline:
    jobs:
      - deploy_app_to_railway:
          filters:
            branches:
              only: [ main ]
