version: 2.1

jobs:
  deploy_app_to_railway:
    docker:
      - image: cimg/node:20.9
    steps:
      - checkout

      - run:
          name: Instalar Railway CLI (local / ad-hoc)
          command: |
            # npx lo descarga al vuelo; --yes evita prompts
            npx -y @railway/cli --version

      - run:
          name: Login con API Key y link al proyecto
          command: |
            npx -y @railway/cli login --apiKey "$RAILWAY_TOKEN"
            npx -y @railway/cli link -p "$RAILWAY_PROJECT_ID"
            # Diagnóstico opcional:
            npx -y @railway/cli status || true

      - run:
          name: Deploy a Railway
          command: |
            # Si tu Dockerfile está en la RAÍZ del repo:
            npx -y @railway/cli up --service "$RAILWAY_SERVICE" --detach

            # Si construyes desde bankchurn-api/, usa en su lugar:
            # cd bankchurn-api
            # npx -y @railway/cli up --service "$RAILWAY_SERVICE" --detach

workflows:
  deploy_pipeline:
    jobs:
      - deploy_app_to_railway:
          filters:
            branches:
              only:
                - main
